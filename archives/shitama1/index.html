<!DOCTYPE HTML>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="SiHuan,思还,Blog,博客,GitBlog" />
    <meta name="generator" content="Maverick 1.1" />
    <meta name="template" content="Galileo" />
    <link rel="alternate" type="application/rss+xml" title="SiHuan's Blog &raquo; RSS 2.0" href="/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="SiHuan's Blog &raquo; ATOM 1.0" href="/feed/atom/index.xml" />
    <link rel="stylesheet" href="/assets/galileo-3f2347c2c0.css">
    <link rel="stylesheet" href="/assets/ExSearch/ExSearch-182e5a8868.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "/fb6dddf7e20a3311708f36bbad33c777.json"
        }
    </script>
    
<title>Shitama 代码分析「概况」 - SiHuan's Blog</title>
<meta name="author" content="SiHuan" />
<meta name="description" content="真就强行分析呗。" />
<meta property="og:title" content="Shitama 代码分析「概况」 - SiHuan's Blog" />
<meta property="og:description" content="真就强行分析呗。" />
<meta property="og:site_name" content="SiHuan's Blog" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/archives/shitama1/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2020-06-01T11:06:00-00.00" />
<meta name="twitter:title" content="Shitama 代码分析「概况」 - SiHuan's Blog" />
<meta name="twitter:description" content="真就强行分析呗。" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />

    </head>
    
    <body>
        
        <div class="container">
            <header id="ga-header">
                <div first>
                    <aside id="ga-logo">
                        <a href="/" target="_self">
                            <img src="/logo.png" alt="SiHuan's Blog">
                        </a>
                    </aside>
                    <aside id="ga-brand">
                        <h1 class="brand"><a class="no-style" href="/">SiHuan's Blog</a></h1>
                        <p>道阻且长，吾意思还。</p>
                    </aside>
                </div>
                <div second id="ga-nav">
                    <nav class="navs">
                        <ul><li><a class="ga-highlight" href="/" target="_self">首页</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/archives/" target="_self">归档</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/enngi/" target="_self">縁起</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/publickey/" target="_self">公钥</a></li><span class="separator">·</span><li><a href="#" target="_self" class="search-form-input ga-highlight">搜索</a></li></ul>
                    </nav>
                    <nav class="social-links">
                        <ul><li><a class="no-style" title="Telegram" href="https://t.me/Si_Huan" target="_blank"><i class="gi gi-telegram"></i>Telegram</a></li><span class="separator">·</span><li><a class="no-style" title="GitHub" href="https://github.com/Si-Huan" target="_blank"><i class="gi gi-github"></i>GitHub</a></li></ul>
                    </nav>
                </div>
            </header>
            <div class="wrapper">
                
<main>    
    <section class="ga-section ga-content">
        <article class="yue">
            <h1 class="ga-post_title">Shitama 代码分析「概况」</h1>
            <span class="ga-post_meta ga-mono">
                <span>SiHuan</span>
                <time>
                    2020-06-01
                </time>
                
                in <a no-style class="category" href="/category/编程/">
                    编程
                </a>
                
                
            </span>
            <div class="ga-content_body">
                <blockquote><p>别看了全是胡扯，我之前理解错有问题，没认真读代码</p>
</blockquote>
<h1>Shitama 的历史</h1>
<blockquote><p>「Shitama」是一个类毛玉服务，可以为「东方非想天则」提供简单的端口转发功能，让身处内网的玩家能够建立主机并进行对战。</p>
</blockquote>
<p>根据 Shitama 的 commit 的记录原作者应该是 <a href="https://github.com/evshiron">evshiron</a> ，不过现在 evshiron 的 github 上已经找不到 shitama 的相关源码，可以找到的是 <a href="https://github.com/u-u-z/shitama">Remi_IO 的一份 fork</a>，现在 <a href="https://github.com/Si-Huan/shitama">Si-Huan/shitama</a> 便是 fork 自 Remi_IO 的 fork .</p>
<h1>非想天则联机机制与 Shitama 实现的功能</h1>
<p>接下来，因为懒，我会将 Shitama 写为 shitama.</p>
<blockquote><p>在此约定: 下文中 <u>主机方</u> 根据不同语境，指 <u>在联机对战中建立主机的那个人</u>、<u>在联机对战中建立主机的那个游戏客户端</u> 或者 <u>在联机对战中建立主机一方的电脑</u>。<u>客机方</u> 指什么大家自己类推一下吧（</p>
</blockquote>
<p>先简略说一下非想天则的联机机制，主机方指定本地端口建立房间，客机方输入主机方 ip:port  进行连接。</p>
<p>那么现在的问题是：</p>
<blockquote><p>如今，网络地址转换（Network Address Translation，NAT）设备如光猫、路由器等日益普及，许多联网设备失去了被从公网访问的能力。尽管某些情况下可以通过调整配置解决，例如对所有途径的NAT设备进行端口映射如配置虚拟服务器、DMZ主机，在多数情况下人们并没有调整配置的权限，如小区宽带，运营商NAT，网吧路由器，甚至拿不到超级帐号的光猫等等。<a href="https://github.com/Si-Huan/shitama/blob/master/docs/zh_CN/Watching.md">Watching.md</a></p>
</blockquote>
<p>shitama 实现的功能是：</p>
<blockquote><p>类毛玉正是为了解决这个问题而出现的。有别于虚拟局域网如Hamachi、QQ对战平台、浩方对战平台、游侠对战平台，类毛玉通过将非想天则主机的端口转发到公网服务器上，使其它用户可以通过公网服务器的端口连接到处于内网的主机，从而进行对战。<a href="https://github.com/Si-Huan/shitama/blob/master/docs/zh_CN/Watching.md">Watching.md</a></p>
</blockquote>
<h1>shitama 构成与一次联机的工作过程图示</h1>
<p>shitama 的分为四部分:</p>
<ul>
<li>clinet</li>
<li>holder</li>
<li>shard</li>
<li>client-ui-qt</li>
</ul>
<p>其中第四部分是 client 的一个壳，与 client 本体通过 http 通信。使用 Qt/C++ 编写，其余部分使用 go 编写，因为本菜鸡全然不了解 Qt/C++ ，故 client-ui-qt 不在本文讨论范围。</p>
<p>在此呢，我先放几张图，大致展示一下在 shitama 帮助下一次联机的过程</p>
<ol>
<li><p>client 向 holder 发起中转请求，请求中指定了 shardAddr 与 transport，即 shard 地址和使用的传输协议（目前只有 UDP 可选）。</p>
</li>
<li><p>holder 收到请求后向被指定的 shard 发起中转请求</p>
</li>
</ol>
<p><figure><img data-width="912" data-height="660" src="/archives/assets/425f820ca9895723772d477ebc81545b.png" alt="申请中转" /><figcaption>申请中转</figcaption></figure></p>
<ol>
<li><p>shard 收到请求后会准备两个端口，此处几位 HostPort 和 GuestPort。并向 holder 返回这两个端口号</p>
</li>
<li><p>holder 收到 shard 发来的端口后向 client 返回这两个端口号</p>
</li>
</ol>
<p><figure><img data-width="912" data-height="660" src="/archives/assets/81d12fb47f947784978b8c710bb7951e.png" alt="shard 返回端口号" /><figcaption>shard 返回端口号</figcaption></figure></p>
<ol>
<li><p>client 得知 shard 已经准备好两个端口后，会建立和 shard:HostPort 的链接，并把 shard:GuestPort 展示给使用者，这时候 client 的使用者就可以通过 im 把 shard:GuestPort 发送给客机方。</p>
</li>
<li><p>客机方在游戏客户端填入 shard:GuestPort 进行联机对战</p>
</li>
</ol>
<p><figure><img data-width="1195" data-height="660" src="/archives/assets/c8b91a3391ee5b4f04d4eac1e7ef7ff4.png" alt="链接建立" /><figcaption>链接建立</figcaption></figure></p>
<p>不难发现其中相对复杂的部分是 shard HostPort 与 GuestPort 之间发生了什么，以及主机方游戏客户端（一般来说为主机方的 10800 端口）与 client 发生了什么。</p>
<p>其实简略来说的话就是，shard GuestPort  和 客机方建立通信，HostPort 和 client 的某个端口（记作 Port1）通信，clinet 的另一个端口（记作 Port2）和主机方游戏客户端通信，主机方客户端发送数据给 Port2， Port2 收到数据会使用 Port1 发出去，也就是发给 HostPort，HostPort 收到数据会通过 GuestPort 发出去也就是发给客机方游戏客户端。因为涉及到观战的问题，主机方 client 的实际情况<del>要比我说的复杂一些</del>远比我说的复杂。</p>
<p><figure><img data-width="1346" data-height="372" src="/archives/assets/a45ce6fb1094844897e18bd373f45524.png" alt="how_shitama_work4" /><figcaption>how_shitama_work4</figcaption></figure></p>
<p>图中虚线的意味： shard1 中由 HostPort 指向 GuestPort 的虚线意味着 HostPort 并不会向 GuestPort 发送数据，而是每当 HostPort 收到来自 Port1 的数据就会使用 GuestPort 发送出去。也就是说 HostPort 只与 Port1 通信。</p>
<p>接下来的几篇博文会比较<del>正经</del>的分析 shitama 的代码。</p>

            </div>
        </article>
        <div id="ga-tags">
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/tag/go/">#go</a>
    </span>
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/tag/shitama/">#shitama</a>
    </span>
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/tag/非想天则/">#非想天则</a>
    </span>
    
</div>
    </section>

    
<section id="ga-content_pager">

    <div class="next">
        <a class="ga-highlight" href="/archives/shitama2/">Shitama 代码分析「holder 启动」</a>
        <p class="yue">shitama 的 holder 启动的时候发生了什么。</p>
    </div>


    <div class="prev">
        <a class="ga-highlight" href="/archives/linuxgpu/">ArchLinux 下双显卡配置</a>
        <p class="yue">我目前使用的双显卡方案</p>
    </div>

</section>


    

</main>

                <footer class="ga-mono" id="ga-footer">
                    <section>
                        <span id="ga-uptime"></span>
                        <span class="brand">SiHuan's Blog</span>
                    </section>
                    <section>
                        <div class="copyright">
                            <span class="footer-addon">
                                
                            </span>
                            <nav class="social-links">
                                <ul><li><a class="no-style" title="Telegram" href="https://t.me/Si_Huan" target="_blank"><i class="gi gi-telegram"></i>Telegram</a></li><span class="separator">·</span><li><a class="no-style" title="GitHub" href="https://github.com/Si-Huan" target="_blank"><i class="gi gi-github"></i>GitHub</a></li></ul>
                            </nav>
                        </div>
                    </section>
                    <script>
                        var site_build_date = "2020-01-01T00:00+08:00"
                    </script>
                    <script src="/assets/galileo-61cf2e8279.js"></script>
                </footer>
            </div>
        </div>
    </div>
        
        
        <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="pswp__bg"></div>
        <div class="pswp__scroll-wrap">
            <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
            </div>
            <div class="pswp__ui pswp__ui--hidden">
                <div class="pswp__top-bar">
                    <div class="pswp__counter"></div>
                    <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                    <button class="pswp__button pswp__button--share" title="Share"></button>
                    <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                    <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                    <div class="pswp__preloader">
                        <div class="pswp__preloader__icn">
                          <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                          </div>
                        </div>
                    </div>
                </div>
                <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                    <div class="pswp__share-tooltip"></div> 
                </div>
                <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
                </button>
                <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
                </button>
                <div class="pswp__caption">
                    <div class="pswp__caption__center"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/ExSearch/jquery.min.js"></script>
    <script src="/assets/ExSearch/ExSearch-493cb9cd89.js"></script>
    
    <!--katex-->
    <link rel="stylesheet" href="/assets/katex.min.css">
    <script defer src="/assets/katex.min.js"></script>
    <script>
    mathOpts = {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
    };
    </script>
    <script defer src="/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

    
    </body>
</html>